<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academia do Saber - Jornada RPG</title>
    <!-- CSS Puro para Tema RPG e Responsividade -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
        
        /* Vari√°veis de Tema */
        :root {
            --bg-dark: #1e1e2d; /* Fundo escuro do calabou√ßo */
            --card-bg: #2d384d; /* Cor da carta/painel */
            --xp-color: #fcd34d; /* Ouro/Amarelo */
            --text-light: #e0e0e0;
            --highlight-green: #48bb78; /* Verde de sucesso/conclu√≠do */
            --border-color: #6366f1; /* Roxo/Azul neon (Efeito M√≠stico) */
        }

        body {
            font-family: 'Cinzel', serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            padding: 10px; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
        }

        /* Estilo da Placa T√≠tulo */
        header {
            text-align: center;
            margin-bottom: 20px; 
        }

        h1 {
            font-size: 30px; 
            font-weight: 700;
            color: var(--xp-color);
            border-bottom: 4px solid var(--border-color);
            padding-bottom: 8px;
            display: inline-block;
            text-shadow: 0 0 10px rgba(252, 211, 77, 0.5);
        }

        /* Estilo Geral do Painel (Card RPG) */
        .rpg-card {
            background-color: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5), inset 0 0 8px rgba(99, 102, 241, 0.5);
        }
        
        /* LOGIN SCREEN STYLES */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            width: 100%;
            max-width: 400px;
        }

        .login-card {
            background-color: var(--card-bg);
            border: 4px solid var(--xp-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(252, 211, 77, 0.3);
            width: 100%;
        }

        .login-card input {
            width: 100%;
            margin-bottom: 15px;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
        }

        .login-card button {
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            font-size: 18px;
        }
        
        /* Estilo da Barra de XP */
        .xp-bar-container {
            height: 25px;
            background-color: #374151;
            border: 2px solid var(--xp-color);
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.7);
            margin-top: 10px;
        }

        .xp-bar {
            background: linear-gradient(90deg, #ca8a04, var(--xp-color));
            height: 100%;
            transition: width 0.7s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #1e1e2d;
            font-weight: bold;
        }

        /* Bot√µes e Inputs */
        .rpg-button {
            background-color: #4a5568;
            color: var(--text-light);
            border: 1px solid var(--xp-color);
            padding: 8px 15px;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: pointer;
            font-family: 'Cinzel', serif;
        }

        .rpg-button:hover {
            background-color: #6a7486;
            box-shadow: 0 0 10px var(--highlight-green);
        }

        input[type="text"], input[type="email"], input[type="password"] {
            background-color: #1f2937;
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 8px;
            border-radius: 4px;
            flex-grow: 1;
        }

        /* Layout Responsivo */
        main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            body {
                padding: 16px;
            }
            h1 {
                font-size: 36px;
            }
            main {
                grid-template-columns: 2fr 1fr;
            }
            #skill-tree-section {
                grid-column: 1 / 3;
            }
        }
        
        /* Lista de Tarefas (Quests) - Estilos para mobile */
        .task-item {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px dashed #4a5568;
            transition: background-color 0.3s;
        }

        .task-item.completed {
            background-color: #1a365d; 
            opacity: 0.7;
            text-decoration: line-through;
        }

        .task-item .task-name {
            flex-grow: 1;
            margin-left: 10px;
            font-size: 14px; 
        }

        .task-item .xp-reward {
            color: var(--xp-color);
            font-size: 0.8em; 
            margin-right: 5px;
            white-space: nowrap;
        }

        .remove-btn {
            background-color: #e53e3e;
            border: none;
            padding: 4px 8px;
            font-size: 10px;
            line-height: 1;
        }
        
        /* Estilo dos Nodes do Mapa Mental (Skill Tree) */
        #skill-tree {
            display: flex;
            justify-content: center;
            gap: 15px; 
            flex-wrap: wrap;
            padding-top: 15px;
        }

        .skill-node {
            width: 45px; 
            height: 45px; 
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            box-sizing: border-box;
            cursor: default;
        }

        .skill-locked {
            background-color: #4a5568;
            border: 3px dashed #9ca3af;
            color: #9ca3af;
            opacity: 0.5;
        }

        .skill-unlocked {
            background-color: var(--highlight-green);
            border: 4px solid var(--xp-color);
            color: var(--bg-dark);
            box-shadow: 0 0 12px var(--highlight-green), 0 0 20px rgba(72, 187, 119, 0.7);
            animation: glow 1.5s infinite alternate;
        }

        @keyframes glow {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        
        #skill-tree > div[style*="font-size: 30px"] {
             font-size: 20px !important; 
        }
    </style>
    <script type="text/javascript">
        // ===================================================================
        // VARI√ÅVEIS DE ESTADO DO JOGO E AUTENTICA√á√ÉO
        // ===================================================================
        
        // Array global para armazenar todos os usu√°rios (her√≥is) cadastrados
        let users = [];
        // √çndice do usu√°rio logado no array 'users'
        let currentUserIndex = -1; 
        
        // Dados do Jogo (ser√£o carregados do objeto do usu√°rio logado)
        let xp = 0;
        let level = 1;
        let tasks = [];
        
        const XP_PER_TASK = 50;
        const XP_BONUS_QUIZ = 50;
        const levelThresholds = [100, 150, 250, 400, 600, 850, 1100, 1400, 1800, 2500];
        
        // Dados do Mini Simulado
        let currentQuestionIndex = -1;
        const quizQuestions = [
            { question: "Qual √© a capital do Brasil?", options: ["Rio de Janeiro", "S√£o Paulo", "Bras√≠lia", "Salvador"], answer: "Bras√≠lia" },
            { question: "Em qual ano o Brasil foi descoberto?", options: ["1500", "1492", "1600", "1822"], answer: "1500" },
            { question: "Quem escreveu 'Dom Casmurro'?", options: ["Machado de Assis", "Jos√© de Alencar", "Clarice Lispector", "Monteiro Lobato"], answer: "Machado de Assis" }
        ];

        // ===================================================================
        // PERSIST√äNCIA LOCAL (LOCAL STORAGE)
        // ===================================================================

        const STORAGE_KEY = 'rpg_study_users';

        /**
         * Carrega o array de usu√°rios do localStorage.
         */
        function loadUsersFromLocalStorage() {
            try {
                const storedUsers = localStorage.getItem(STORAGE_KEY);
                if (storedUsers) {
                    users = JSON.parse(storedUsers);
                } else {
                    users = []; // Array vazio se nada for encontrado
                }
            } catch (e) {
                console.error("Erro ao carregar dados do localStorage:", e);
                users = [];
            }
        }

        /**
         * Salva o array de usu√°rios no localStorage.
         */
        function saveUsersToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
            } catch (e) {
                console.error("Erro ao salvar dados no localStorage:", e);
            }
        }
        
        /**
         * Salva o progresso do her√≥i logado.
         */
        function saveUserData() {
            if (currentUserIndex === -1) return;

            // Atualiza o objeto do usu√°rio logado no array 'users'
            users[currentUserIndex].xp = xp;
            users[currentUserIndex].level = level;
            users[currentUserIndex].tasks = tasks;
            
            // Salva o array completo no localStorage
            saveUsersToLocalStorage();
        }

        /**
         * Carrega o progresso do her√≥i logado nas vari√°veis globais.
         */
        function loadUserData() {
            if (currentUserIndex === -1) return;
            
            const userData = users[currentUserIndex];
            xp = userData.xp;
            level = userData.level;
            tasks = userData.tasks;
            
            document.getElementById('player-id').textContent = userData.email;
            
            updateProgressAnimation();
            renderTaskList();
            checkSkillTree();
        }

        // ===================================================================
        // AUTENTICA√á√ÉO LOCAL (LOGIN/CADASTRO)
        // ===================================================================

        /**
         * Lida com o processo de Login (Sign In).
         */
        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const feedback = document.getElementById('auth-feedback');

            if (!email || !password) {
                feedback.textContent = "Preencha e-mail e senha.";
                return;
            }

            const userIndex = users.findIndex(u => u.email === email && u.password === password);

            if (userIndex !== -1) {
                currentUserIndex = userIndex;
                feedback.textContent = "Login bem-sucedido! Iniciando Jornada...";
                setTimeout(showMainApp, 500);
            } else {
                feedback.textContent = "Erro ao fazer login. E-mail ou senha incorretos.";
            }
        }
        
        /**
         * Lida com o processo de Cria√ß√£o de Conta (Sign Up).
         */
        function handleSignUp() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const feedback = document.getElementById('auth-feedback');

            if (!email || !password || password.length < 6) {
                feedback.textContent = "E-mail e senha (m√≠n. 6 caracteres) s√£o obrigat√≥rios.";
                return;
            }

            if (users.some(u => u.email === email)) {
                feedback.textContent = "Este e-mail j√° possui um Her√≥i cadastrado.";
                return;
            }
            
            // Cria novo Her√≥i com dados iniciais
            const newHero = {
                email: email,
                password: password,
                xp: 0,
                level: 1,
                tasks: [
                    { id: 1, name: "Concluir o Tutorial de Cadastro", completed: false, xp: XP_PER_TASK },
                    { id: 2, name: "Revisar as Regras M√≠sticas (Fun√ß√µes JS)", completed: false, xp: XP_PER_TASK }
                ]
            };

            users.push(newHero);
            saveUsersToLocalStorage(); // Salva o novo usu√°rio

            currentUserIndex = users.length - 1;
            feedback.textContent = "Novo Her√≥i criado com sucesso! Entrando no jogo...";
            setTimeout(showMainApp, 500);
        }

        /**
         * Mostra a tela principal do aplicativo.
         */
        function showMainApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app-content').style.display = 'block';
            loadUserData();
        }

        // ===================================================================
        // FUN√á√ïES DE PROGRESSO (XP/N√çVEL)
        // ===================================================================

        function getXPThreshold(currentLevel) {
            if (currentLevel <= levelThresholds.length) {
                return levelThresholds[currentLevel - 1];
            }
            return levelThresholds[levelThresholds.length - 1] + (currentLevel - levelThresholds.length) * 300;
        }

        function updateProgressAnimation() {
            const nextThreshold = getXPThreshold(level);
            let percentage;

            if (level === 1) {
                percentage = (xp / nextThreshold) * 100;
            } else {
                // C√°lculo de XP dentro do n√≠vel atual
                const prevThreshold = getXPThreshold(level - 1);
                const xpGainedInLevel = xp - prevThreshold;
                const totalXpInLevel = nextThreshold - prevThreshold;
                percentage = (xpGainedInLevel / totalXpInLevel) * 100;
            }
            
            percentage = Math.max(0, Math.min(100, percentage));

            const xpBar = document.getElementById('xp-bar');
            xpBar.style.width = `${percentage}%`;
            xpBar.textContent = `${Math.floor(percentage)}%`;
            
            document.getElementById('xp-current-display').textContent = xp;
            document.getElementById('xp-next-display').textContent = nextThreshold;
            document.getElementById('player-level-display').textContent = `N√≠vel ${level}`;
            
            checkSkillTree();
        }

        function gainXP(amount) {
            xp += amount;
            
            let leveledUp = false;
            let nextThreshold = getXPThreshold(level);

            while (xp >= nextThreshold) {
                level++;
                leveledUp = true;
                nextThreshold = getXPThreshold(level);
            }

            if (leveledUp) {
                const msg = document.getElementById('level-up-message');
                msg.textContent = `üí• N√çVEL UP! Voc√™ alcan√ßou o N√≠vel ${level}! üí•`;
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
            }

            updateProgressAnimation();
            saveUserData(); // Salva no array e localStorage
        }

        // ===================================================================
        // CRONOGRAMA (GEST√ÉO DE TAREFAS)
        // ===================================================================

        function renderTaskList() {
            const listElement = document.getElementById('task-list');
            listElement.innerHTML = '';
            
            if (tasks.length === 0) {
                listElement.innerHTML = `<p style="opacity: 0.7; text-align: center; padding: 20px; font-size: 14px;">Nenhuma Quest ativa. Adicione uma nova Quest acima!</p>`;
                return;
            }

            tasks.forEach(task => {
                const item = document.createElement('div');
                item.className = 'task-item' + (task.completed ? ' completed' : '');
                
                item.innerHTML = `
                    <input type="checkbox" id="task-${task.id}" 
                           style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--highlight-green);"
                           ${task.completed ? 'checked disabled' : ''}>
                    <span class="task-name">${task.name}</span>
                    <span class="xp-reward">(+${task.xp || XP_PER_TASK} XP)</span>
                    <button class="rpg-button remove-btn" data-id="${task.id}">
                        X
                    </button>
                `;

                // Listener para completar a tarefa
                if (!task.completed) {
                    item.querySelector('input').addEventListener('change', () => {
                        completeTask(task.id, task.xp || XP_PER_TASK);
                    });
                }
                
                // Listener para remover a tarefa
                item.querySelector('.remove-btn').addEventListener('click', (e) => {
                    removeTask(parseInt(e.target.getAttribute('data-id')));
                });

                listElement.appendChild(item);
            });
        }
        
        function completeTask(taskId, xpAmount) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1 && !tasks[taskIndex].completed) {
                tasks[taskIndex].completed = true;
                gainXP(xpAmount);
                renderTaskList();
            }
        }

        function addTaskHandler() {
            const inputElement = document.getElementById('new-task-input');
            const taskName = inputElement.value.trim();
            
            if (taskName) {
                // IDs devem ser √∫nicos e crescentes.
                const newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
                tasks.push({ 
                    id: newId, 
                    name: taskName, 
                    completed: false, 
                    xp: XP_PER_TASK 
                });
                inputElement.value = ''; // Limpa o input
                renderTaskList();
                saveUserData();
            }
        }
        
        function removeTask(taskId) {
            tasks = tasks.filter(t => t.id !== taskId);
            renderTaskList();
            saveUserData();
        }

        // ===================================================================
        // MAPA MENTAL (SKILL TREE)
        // ===================================================================

        function checkSkillTree() {
            const nodes = document.querySelectorAll('#skill-tree .skill-node');
            nodes.forEach(node => {
                const requiredLevel = parseInt(node.getAttribute('data-level'));
                const skillName = node.getAttribute('data-skill');

                if (level >= requiredLevel) {
                    node.classList.remove('skill-locked');
                    node.classList.add('skill-unlocked');
                    node.title = `Conhecimento Desbloqueado: ${skillN